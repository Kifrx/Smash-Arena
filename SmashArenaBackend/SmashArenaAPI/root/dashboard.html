<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Smash Arena</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <style>
      :root {
        --primary-green: #198754;
      }
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", sans-serif;
      }
      .navbar-brand {
        font-weight: bold;
        color: var(--primary-green) !important;
        font-size: 1.5rem;
      }
      .table-hover tbody tr:hover {
        background-color: #f1f8f5;
      }
      .badge {
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm"
    >
      <div class="container">
        <a class="navbar-brand" href="index.html">üè∏ Smash Arena</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div
          class="collapse navbar-collapse justify-content-end"
          id="navbarNav"
        >
          <div id="dynamicNav"></div>
        </div>
      </div>
    </nav>

    <div class="container mt-4 d-none" id="successAlert">
      <div
        class="alert alert-success alert-dismissible fade show shadow-sm border-0 border-start border-success border-4"
        role="alert"
      >
        <i class="fas fa-check-circle me-2"></i>
        <strong>Booking Successful!</strong> Your schedule has been secured.
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
    </div>

    <div class="container py-4">
      <div class="row mb-4">
        <div class="col-12">
          <h2 class="fw-bold">My Bookings</h2>
          <p class="text-muted">
            Manage your play schedule and view booking history.
          </p>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light text-uppercase small fw-bold text-muted">
                <tr>
                  <th class="ps-4 py-3">Play Date</th>
                  <th>Court</th>
                  <th>Time</th>
                  <th>Total Price</th>
                  <th>Status</th>
                  <th class="text-end pe-4">Action</th>
                </tr>
              </thead>
              <tbody id="bookingTableBody">
                <tr>
                  <td colspan="6" class="text-center py-5">
                    <div
                      class="spinner-border text-success"
                      role="status"
                    ></div>
                    <p class="text-muted mt-2">Loading data...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="cancelToast"
        class="toast align-items-center text-white bg-secondary border-0"
        role="alert"
      >
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-info-circle me-2"></i> Booking has been cancelled.
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // 1. NAVBAR
      function renderNavbar() {
        const userData = localStorage.getItem("user_data");
        if (!userData) {
          window.location.href = "login.html";
          return;
        }

        const user = JSON.parse(userData);
        const shortName = (
          user.namaLengkap ||
          user.nama_Lengkap ||
          "User"
        ).split(" ")[0];

        window.currentUserId = user.userId || user.User_ID || user.user_ID;

        const container = document.getElementById("dynamicNav");

        container.innerHTML = `
             <div class="navbar-nav align-items-center gap-3">
                <a href="index.html" class="btn btn-outline-secondary rounded-pill px-4 fw-bold border-0">
                    <i class="fas fa-home me-2"></i>Home
                </a>

                <div class="vr mx-1 d-none d-lg-block"></div>

                <span class="fw-bold text-secondary">Hai, ${shortName}</span>

                <button onclick="logout()" class="btn btn-sm btn-outline-danger rounded-circle shadow-sm" title="Logout" style="width: 38px; height: 38px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-power-off"></i>
                </button>
             </div>
          `;
      }

      // 2. DATA BOOKING
      async function fetchMyBookings() {
        try {
          const response = await fetch(
            `/api/Bookings/user/${window.currentUserId}`
          );
          const tbody = document.getElementById("bookingTableBody");

          if (!response.ok) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">No booking history found. <br> <a href="index.html" class="btn btn-sm btn-success mt-2">Book Now</a></td></tr>`;
            return;
          }

          const bookings = await response.json();

          if (bookings.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">You haven't booked any court yet.</td></tr>`;
            return;
          }

          tbody.innerHTML = "";

          bookings.forEach((b) => {
            // Format Tanggal
            const dateObj = new Date(b.tanggalMain || b.TanggalMain);
            const dateString = dateObj.toLocaleDateString("en-GB", {
              day: "numeric",
              month: "short",
              year: "numeric",
            });

            // Format Jam
            let start = (b.jamMulai || b.JamMulai).toString().substring(0, 5);
            let end = (b.jamSelesai || b.JamSelesai).toString().substring(0, 5);

            // Format Harga
            const price = (b.totalHarga || b.TotalHarga).toLocaleString(
              "id-ID"
            );

            // Logic Status Badge
            let status = b.statusBooking || b.StatusBooking || "Confirmed";
            let badgeClass = "bg-success bg-opacity-10 text-success";
            let btnState = "";

            if (status === "Cancelled") {
              badgeClass = "bg-secondary bg-opacity-10 text-secondary";
              btnState = "disabled";
            } else if (status === "Finished") {
              badgeClass = "bg-primary bg-opacity-10 text-primary";
              btnState = "disabled";
            }

            const bookingId = b.bookingId || b.BookingId;

            const row = `
                    <tr>
                      <td class="ps-4 fw-bold">${dateString}</td>
                      <td>
                        <span class="d-block fw-bold">${
                          b.court?.namaCourt || "Unknown Court"
                        }</span>
                      </td>
                      <td>${start} - ${end}</td>
                      <td class="text-success fw-bold">Rp ${price}</td>
                      <td>
                        <span class="badge ${badgeClass}">${status}</span>
                      </td>
                      <td class="text-end pe-4">
                        <button
                          class="btn btn-sm ${
                            status === "Confirmed"
                              ? "btn-outline-danger"
                              : "btn-light text-muted"
                          }"
                          onclick="cancelBooking(this, '${bookingId}')" ${btnState}
                        >
                          <i class="fas fa-times me-1"></i> Cancel
                        </button>
                      </td>
                    </tr>
                  `;
            tbody.innerHTML += row;
          });
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "bookingTableBody"
          ).innerHTML = `<tr><td colspan="6" class="text-center text-danger">Server Error. Please check backend.</td></tr>`;
        }
      }

      // 3. FUNGSI LOGOUT
      function logout() {
        Swal.fire({
          title: "Yakin mau keluar?",
          text: "Sesi Anda akan berakhir.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Ya, Logout!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem("user_data");
            Swal.fire({
              title: "Berhasil Logout!",
              text: "Sampai jumpa lagi! üëã",
              icon: "success",
              timer: 1500,
              showConfirmButton: false,
            }).then(() => {
              window.location.href = "index.html";
            });
          }
        });
      }

      // 4. FUNGSI CANCEL
      async function cancelBooking(btn, bookingId) {
        if (confirm("Yakin mau membatalkan booking ini?")) {
          try {
            const response = await fetch(`/api/Bookings/cancel/ ${bookingId}`, {
              method: "PUT",
            });

            if (response.ok) {
              const row = btn.closest("tr");
              const statusCell = row.querySelectorAll("td")[4];

              statusCell.innerHTML =
                '<span class="badge bg-secondary bg-opacity-10 text-secondary">Cancelled</span>';

              btn.classList.remove("btn-outline-danger");
              btn.classList.add("btn-light", "text-muted", "disabled");
              btn.disabled = true;

              const toastEl = document.getElementById("cancelToast");
              const toast = new bootstrap.Toast(toastEl);
              toast.show();
            } else {
              alert("Gagal membatalkan. Pastikan server nyala.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error koneksi ke server!");
          }
        }
      }

      renderNavbar();
      fetchMyBookings();
    </script>
  </body>
</html>
