<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Smash Arena</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --primary-green: #198754;
      }
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", sans-serif;
      }
      .navbar-brand {
        font-weight: bold;
        color: var(--primary-green) !important;
        font-size: 1.5rem;
      }
      .nav-link {
        color: #555;
        font-weight: 500;
        cursor: pointer;
      }
      .nav-link:hover,
      .nav-link.active {
        color: var(--primary-green);
      }
      .court-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        background: white;
        transition: transform 0.2s;
      }
      .court-card:hover {
        transform: translateY(-5px);
      }
      .court-img {
        height: 180px;
        object-fit: cover;
      }
      .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
      }
      .table-responsive {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm"
    >
      <div class="container">
        <a class="navbar-brand" href="#">
          üè∏ Smash Arena
          <span
            class="badge bg-dark fs-6 ms-2"
            style="font-size: 0.7rem; vertical-align: middle"
            >ADMIN</span
          >
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div
          class="collapse navbar-collapse justify-content-end"
          id="navbarNav"
        >
          <div id="dynamicNav"></div>
        </div>
      </div>
    </nav>

    <div class="container py-5">
      <div id="section-courts">
        <div class="row mb-4 align-items-center">
          <div class="col-md-8">
            <h2 class="fw-bold">Manage Courts</h2>
            <p class="text-muted">Add, remove, or update court information.</p>
          </div>
          <div class="col-md-4 text-end">
            <button
              class="btn btn-success fw-bold shadow-sm"
              data-bs-toggle="modal"
              data-bs-target="#addCourtModal"
            >
              <i class="fas fa-plus me-1"></i> Add New Court
            </button>
          </div>
        </div>
        <div class="row g-4" id="adminCourtContainer">
          <div class="col-12 loading-container">
            <div class="spinner-border text-success" role="status"></div>
          </div>
        </div>
      </div>

      <div id="section-bookings" style="display: none">
        <div class="row mb-4">
          <div class="col-12">
            <h2 class="fw-bold">Booking History</h2>
            <p class="text-muted">Monitor all incoming reservations.</p>
          </div>
        </div>

        <div class="table-responsive border-0">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-uppercase small fw-bold text-muted">
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Court</th>
                <th>Time</th>
                <th>Status</th>
                <th>Total Price</th>
              </tr>
            </thead>
            <tbody id="bookingTableBody">
              <tr>
                <td colspan="6" class="text-center py-5">Loading data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addCourtModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold">Add New Court</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form onsubmit="addCourt(event)">
              <div class="mb-3">
                <label class="form-label fw-bold">Court Name</label>
                <input
                  type="text"
                  id="addName"
                  class="form-control"
                  placeholder="e.g. Court A"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Price per Hour (Rp)</label>
                <input
                  type="number"
                  id="addPrice"
                  class="form-control"
                  placeholder="e.g. 100000"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Floor Type</label>
                <select id="addType" class="form-select">
                  <option>Vinyl</option>
                  <option>Parquet</option>
                  <option>Cement</option>
                  <option>Synthetic</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Facilities</label>
                <input
                  type="text"
                  id="addFacilities"
                  class="form-control"
                  placeholder="e.g. AC, WiFi"
                />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Image URL</label>
                <input
                  type="text"
                  id="addImage"
                  class="form-control"
                  placeholder="https://..."
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-success fw-bold">
                  Save Court
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editCourtModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-warning bg-opacity-10">
            <h5 class="modal-title fw-bold text-dark">Edit Court Data</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form onsubmit="updateCourt(event)">
              <input type="hidden" id="editId" />
              <div class="mb-3">
                <label class="form-label fw-bold">Court Name</label
                ><input
                  type="text"
                  id="editName"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Price (Rp)</label
                ><input
                  type="number"
                  id="editPrice"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Floor Type</label
                ><select id="editType" class="form-select">
                  <option>Vinyl</option>
                  <option>Parquet</option>
                  <option>Cement</option>
                  <option>Synthetic</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Facilities</label
                ><input type="text" id="editFacilities" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Image URL</label
                ><input
                  type="text"
                  id="editImage"
                  class="form-control"
                  required
                />
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-warning fw-bold">
                  Update Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_URL = "/api/Courts";
      const BOOKING_URL = "/api/Bookings";
      let allCourts = [];

      // 1. NAVBAR
      function renderNavbar() {
        const userData = localStorage.getItem("user_data");
        if (!userData) {
          window.location.href = "login.html";
          return;
        }

        const user = JSON.parse(userData);
        const shortName = (
          user.namaLengkap ||
          user.nama_Lengkap ||
          "Admin"
        ).split(" ")[0];

        const container = document.getElementById("dynamicNav");

        container.innerHTML = `
             <div class="navbar-nav align-items-center gap-3">
                <a class="nav-link fw-bold" id="menuCourts" onclick="switchTab('courts')" style="cursor: pointer">Manage Courts</a>
                <a class="nav-link fw-bold" id="menuBookings" onclick="switchTab('bookings')" style="cursor: pointer">Check Bookings</a>

                <div class="vr mx-2 d-none d-lg-block"></div>

                <a href="index.html" class="btn btn-outline-dark rounded-pill px-3 fw-bold border-0 text-muted">
                    <i class="fas fa-home"></i>
                </a>

                <span class="fw-bold text-secondary">Hai, ${shortName}</span>

                <button onclick="logout()" class="btn btn-sm btn-outline-danger rounded-circle shadow-sm" title="Logout" style="width: 38px; height: 38px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-power-off"></i>
                </button>
             </div>
          `;

        document.getElementById("menuCourts").classList.add("active");
      }

      // 2. Pindah TABS
      function switchTab(tabName) {
        document.getElementById("section-courts").style.display = "none";
        document.getElementById("section-bookings").style.display = "none";

        document.getElementById("menuCourts").classList.remove("active");
        document.getElementById("menuBookings").classList.remove("active");

        if (tabName === "courts") {
          document.getElementById("section-courts").style.display = "block";
          document.getElementById("menuCourts").classList.add("active");
          loadCourts();
        } else {
          document.getElementById("section-bookings").style.display = "block";
          document.getElementById("menuBookings").classList.add("active");
          loadBookings();
        }
      }

      // 3. LOAD COURTS
      async function loadCourts() {
        try {
          const response = await fetch(API_URL);
          allCourts = await response.json();

          const container = document.getElementById("adminCourtContainer");
          container.innerHTML = "";

          if (allCourts.length === 0) {
            container.innerHTML =
              '<div class="col-12 text-center text-muted py-5">No courts available.</div>';
            return;
          }

          allCourts.forEach((c) => {
            const id = c.courtId || c.CourtId;
            const name = c.namaCourt || c.NamaCourt;
            const price = c.hargaPerJam || c.HargaPerJam;
            const img = c.gambarUrl || c.GambarUrl;
            const floor = c.jenisLantai || c.JenisLantai;

            const html = `
                    <div class="col-md-4">
                        <div class="card court-card h-100">
                            <img src="${img}" class="card-img-top court-img" alt="${name}" onerror="this.src='https://via.placeholder.com/400?text=No+Image'">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="card-title fw-bold mb-0 text-success">${name}</h5>
                                    <span class="badge bg-secondary">${floor}</span>
                                </div>
                                <p class="text-muted fw-bold mb-3 fs-5">Rp ${price.toLocaleString()}<span class="fs-6 fw-normal">/Hour</span></p>
                                <div class="mt-auto row g-2">
                                    <div class="col-6"><button class="btn btn-outline-warning w-100 fw-bold text-dark" onclick="openEditModal('${id}')"><i class="fas fa-edit"></i> Edit</button></div>
                                    <div class="col-6"><button class="btn btn-outline-danger w-100 fw-bold" onclick="deleteCourt('${id}')"><i class="fas fa-trash-alt"></i> Del</button></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            container.innerHTML += html;
          });
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // 4. LOAD BOOKINGS
      async function loadBookings() {
        try {
          const response = await fetch(BOOKING_URL);
          const bookings = await response.json();
          const tbody = document.getElementById("bookingTableBody");
          tbody.innerHTML = "";

          if (bookings.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">Belum ada data booking masuk.</td></tr>`;
            return;
          }

          bookings.forEach((b) => {
            const dateObj = new Date(b.tanggalMain || b.TanggalMain);
            const dateString = dateObj.toLocaleDateString("en-GB", {
              day: "numeric",
              month: "short",
              year: "numeric",
            });

            let start = (b.jamMulai || b.JamMulai).toString().substring(0, 5);
            let end = (b.jamSelesai || b.JamSelesai).toString().substring(0, 5);

            const userName = b.user
              ? b.user.namaLengkap || b.user.NamaLengkap
              : "Unknown User";
            const courtName = b.court
              ? b.court.namaCourt || b.court.NamaCourt
              : "Unknown Court";

            let status = b.statusBooking || b.StatusBooking;
            let badgeClass =
              status === "Confirmed" ? "bg-success" : "bg-secondary";
            if (status === "Cancelled") badgeClass = "bg-danger";

            const row = `
                        <tr>
                            <td class="fw-bold text-muted">${dateString}</td>
                            <td class="fw-bold">${userName}</td>
                            <td>${courtName}</td>
                            <td>${start} - ${end}</td>
                            <td><span class="badge ${badgeClass}">${status}</span></td>
                            <td class="text-success fw-bold">Rp ${(
                              b.totalHarga || b.TotalHarga
                            ).toLocaleString()}</td>
                        </tr>
                    `;
            tbody.innerHTML += row;
          });
        } catch (error) {
          console.error(error);
          document.getElementById(
            "bookingTableBody"
          ).innerHTML = `<tr><td colspan="6" class="text-center text-danger">Gagal memuat data.</td></tr>`;
        }
      }

      async function addCourt(event) {
        event.preventDefault();
        const newCourt = {
          namaCourt: document.getElementById("addName").value,
          hargaPerJam: parseFloat(document.getElementById("addPrice").value),
          jenisLantai: document.getElementById("addType").value,
          fasilitas: document.getElementById("addFacilities").value,
          gambarUrl: document.getElementById("addImage").value,
          statusAktif: true,
        };
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newCourt),
        });
        alert("Berhasil!");
        window.location.reload();
      }

      function openEditModal(id) {
        const court = allCourts.find((c) => (c.courtId || c.CourtId) === id);
        if (court) {
          document.getElementById("editId").value = id;
          document.getElementById("editName").value =
            court.namaCourt || court.NamaCourt;
          document.getElementById("editPrice").value =
            court.hargaPerJam || court.HargaPerJam;
          document.getElementById("editType").value =
            court.jenisLantai || court.JenisLantai;
          document.getElementById("editFacilities").value =
            court.fasilitas || court.Fasilitas;
          document.getElementById("editImage").value =
            court.gambarUrl || court.GambarUrl;
          new bootstrap.Modal(document.getElementById("editCourtModal")).show();
        }
      }

      async function updateCourt(event) {
        event.preventDefault();
        const id = document.getElementById("editId").value;
        const updatedCourt = {
          courtId: id,
          namaCourt: document.getElementById("editName").value,
          hargaPerJam: parseFloat(document.getElementById("editPrice").value),
          jenisLantai: document.getElementById("editType").value,
          fasilitas: document.getElementById("editFacilities").value,
          gambarUrl: document.getElementById("editImage").value,
          statusAktif: true,
        };
        await fetch(`${API_URL}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedCourt),
        });
        alert("Update Berhasil!");
        window.location.reload();
      }

      async function deleteCourt(id) {
        if (confirm("Hapus?")) {
          await fetch(`${API_URL}/${id}`, { method: "DELETE" });
          loadCourts();
        }
      }

      function logout() {
        Swal.fire({
          title: "Logout?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "Yes",
        }).then((result) => {
          if (result.isConfirmed) {
            localStorage.removeItem("user_data");
            window.location.href = "index.html";
          }
        });
      }

      renderNavbar();
      loadCourts();
    </script>
  </body>
</html>
